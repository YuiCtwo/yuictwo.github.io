<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>单文件 MongoDB 服务器（1） - Ctwo&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Ctwo&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Ctwo&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="引子 是的我找回了自己的博客 起因是我的小伙伴在假期提出了一个需求：  在单个文件中存储数据，并使用 MongoDB 的方式来存取 还附上了已有开发者做的项目 TinyMongo 但上面这个项目，并不能使用现有的工具来进行连接（比如说 MongoDB Compass） 原因也很简单，项目只实现了一个 Client，并没有一个 Server 来与其他软件进行通信。  我寻思，这个问题看起来不难~~（"><meta property="og:type" content="blog"><meta property="og:title" content="单文件 MongoDB 服务器（1）"><meta property="og:url" content="http://cyx0706.github.io/2025/03/20/mongodb/"><meta property="og:site_name" content="Ctwo&#039;s Blog"><meta property="og:description" content="引子 是的我找回了自己的博客 起因是我的小伙伴在假期提出了一个需求：  在单个文件中存储数据，并使用 MongoDB 的方式来存取 还附上了已有开发者做的项目 TinyMongo 但上面这个项目，并不能使用现有的工具来进行连接（比如说 MongoDB Compass） 原因也很简单，项目只实现了一个 Client，并没有一个 Server 来与其他软件进行通信。  我寻思，这个问题看起来不难~~（"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://cyx0706.github.io/img/og_image.png"><meta property="article:published_time" content="2025-03-20T12:42:24.000Z"><meta property="article:modified_time" content="2025-05-08T09:04:36.377Z"><meta property="article:author" content="Ctwo"><meta property="article:tag" content="mongodb"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://cyx0706.github.io/2025/03/20/mongodb/"},"headline":"单文件 MongoDB 服务器（1）","image":["http://cyx0706.github.io/img/og_image.png"],"datePublished":"2025-03-20T12:42:24.000Z","dateModified":"2025-05-08T09:04:36.377Z","author":{"@type":"Person","name":"Ctwo"},"publisher":{"@type":"Organization","name":"Ctwo's Blog","logo":{"@type":"ImageObject","url":"http://cyx0706.github.io/img/logo.svg"}},"description":"引子 是的我找回了自己的博客 起因是我的小伙伴在假期提出了一个需求：  在单个文件中存储数据，并使用 MongoDB 的方式来存取 还附上了已有开发者做的项目 TinyMongo 但上面这个项目，并不能使用现有的工具来进行连接（比如说 MongoDB Compass） 原因也很简单，项目只实现了一个 Client，并没有一个 Server 来与其他软件进行通信。  我寻思，这个问题看起来不难~~（"}</script><link rel="canonical" href="http://cyx0706.github.io/2025/03/20/mongodb/"><link rel="alternate" href="/atom.xml" title="Ctwo&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/railscasts.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.2"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Ctwo&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2025-03-20T12:42:24.000Z" title="2025/3/20 20:42:24">2025-03-20</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-05-08T09:04:36.377Z" title="2025/5/8 17:04:36">2025-05-08</time></span><span class="level-item"><a class="link-muted" href="/categories/database/">database</a></span></div></div><h1 class="title is-3 is-size-4-mobile">单文件 MongoDB 服务器（1）</h1><div class="content"><h2 id="引子">引子</h2>
<p><s>是的我找回了自己的博客</s></p>
<p>起因是我的小伙伴在假期提出了一个需求：</p>
<blockquote>
<p>在单个文件中存储数据，并使用 MongoDB 的方式来存取<br>
还附上了已有开发者做的项目 <a target="_blank" rel="noopener" href="https://github.com/schapman1974/tinymongo">TinyMongo</a><br>
但上面这个项目，并不能使用现有的工具来进行连接（比如说 MongoDB Compass）<br>
原因也很简单，项目只实现了一个 Client，并没有一个 Server 来与其他软件进行通信。</p>
</blockquote>
<p>我寻思，这个问题看起来不难~~（真的吗？）~~，而且我本身也对数据库服务器这块感兴趣，便开始着手研究和编写代码。<br>
由于读写已经由别的项目完成了，所以我只需要专注于完成 “服务器” 应该干的事情。</p>
<p>那么，数据库服务器应该干什么呢？<br>
不知道，没一点头绪，该死的本科水专业课，只会让人背 SQL 语句。<br>
教程，貌似也没有完全面向小白的。<br>
那就撸袖子干，写到哪里算哪里，等对问题有基本认知了再来回头重构代码，学习更优秀的设计，参考开源代码。<br>
GO，GO，先搓起来先~</p>
<p>注意！！！<br>
本人对数据库是完全的小白，该系列纯粹是为本人在学习过程中的记录，包括但不限于“我寻思应该这样写”。代码可能不美观，但我相信它会随着我对这个问题的掌握逐渐越来越好了。</p>
<p><s>希望哪天做 AI 失业了还能靠学习的这个吃口饭</s></p>
<p><strong>小目标是搭一个能跑起来的服务！不问性能</strong></p>
<span id="more"></span>
<p>MongoDB 基于 TCP 协议来实现通信，在 Python 里实现一个 TCP 服务器也很简单，基于 socket 库即可：</p>
<blockquote>
<p>Python 中的 socket 模块是用于实现网络通信的模块，提供了底层网络操作的接口，使得用户可以通过网络实现客户端和服务器之间的数据传输、连接和通信。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">server_socket.bind((host, port))</span><br><span class="line"><span class="comment"># set maximum number of connections</span></span><br><span class="line">server_socket.listen(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># log server start</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Server started on <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>host, port 分别是地址和端口，例如<code>host=&quot;127.0.0.1&quot;, port=&quot;27019&quot;</code></p>
<p>MongoDB 官方文档给出了定义的通信格式 <a target="_blank" rel="noopener" href="https://www.mongodb.com/zh-cn/docs/manual/reference/mongodb-wire-protocol/">mongodb-wire-protocol</a> 我只能说可读性很差的。<br>
这里对它的内容进行简单的整理：</p>
<p>请求应包括<strong>消息头</strong>和<strong>请求有效负载</strong>，而响应则包括<strong>消息头</strong>和<strong>响应有效负载</strong></p>
<p>需要注意：</p>
<ul>
<li>请求和响应的有效负载并不相同</li>
<li>消息头和有效负载都是 BSON 格式的二进制数据</li>
<li>消息的排序遵循小端序（little-endian）</li>
</ul>
<p>而 BSON（Binary JSON）是一种二进制形式的 JSON 文档。它是 MongoDB 数据库的默认数据存储格式。</p>
<h2 id="消息头">消息头</h2>
<p>官方文档给出消息头的定义为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MsgHeader</span> &#123;</span></span><br><span class="line">    int32   messageLength; <span class="comment">// total message size, including this</span></span><br><span class="line">    int32   requestID;     <span class="comment">// identifier for this message</span></span><br><span class="line">    int32   responseTo;    <span class="comment">// requestID from the original request</span></span><br><span class="line">                           <span class="comment">//  (used in responses from the database)</span></span><br><span class="line">    int32   opCode;        <span class="comment">// message type</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>messageLength：整个消息的大小，包括消息头</li>
<li>requestID：每个请求的唯一标识符，由客户端或数据库生成</li>
<li>responseTo：如果是响应，则为请求的 requestID；如果是请求，则为 0</li>
<li>opCode：消息类型，包括请求、响应、错误、通知等</li>
</ul>
<p>无论是请求还是响应，都要遵循该消息头来进行传输</p>
<h2 id="有效负载">有效负载</h2>
<p>这个就五花八门了，现在网上大部分的资料都是基于 5.1 版本的前的，对于 opCode 中的例如 <code>OP_QUERY</code>, <code>OP_INSERT</code>, <code>OP_QUERY</code> 等等都有很详尽的定义，详细的可以在旧版本的操作码中找到，至于新版，换成了统一的了。</p>
<p>从 5.1 版本开始，<code>OP_MSG</code> 和 <code>OP_COMPRESSED</code> 是向 Server 发送请求时唯一支持的操作码</p>
<p><code>OP_COMPRESSED</code> 是 5.1 版本的压缩请求，用于支持压缩数据。<code>OP_MSG</code> 是 5.1 版本的消息请求，用于支持多文档事务。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OP_MSG &#123;</span><br><span class="line">    MsgHeader header;           // standard message header</span><br><span class="line">    uint32 flagBits;            // message flags</span><br><span class="line">    Sections[] sections;        // data sections</span><br><span class="line">    optional&lt;uint32&gt; checksum;  // optional CRC-32C checksum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比较关键的部分在于：flagBits 标志位和 sections 消息数组：</p>
<ul>
<li>flagBits: 前 16 位必须有，我个人的理解是只能设置有实际含义的二进制位，否则，解析器则必须报错，对应原文是 <code>&quot;The first 16 bits (0-15) are required and parsers MUST error if an unknown bit is set.&quot;</code><br>
最后 16 位是可选的，允许设置一些额外的标志位，但代理和其他消息转发器必须在转发消息之前清除任何未知的可选位。</li>
</ul>
<p>sections 中可以包含单个的 BSON 对象，也可以包含一个文档。<br>
文档是 MongoDB 的基本数据单元，使用 BSON 格式存储。一个文档包含了一组键值对，类似于 JSON 对象。<br>
如： <code>&#123;&quot;name&quot;: &quot;John&quot;, &quot;age&quot;: 30, &quot;city&quot;: &quot;New York&quot;&#125;</code></p>
<p>看完了，SO？首先作为客户端连接服务器要发什么请求？作为服务端返回的内容又包含了什么？</p>
<h2 id="握手请求">握手请求</h2>
<p>我们都知道和服务器建立连接前都要先尝试“握手”，即发送一些配置信息来确定双方后续沟通的一些细节。我姑且把这样的部分成为“握手阶段”。</p>
<p>客户端要和 MongoDB 的服务器建立通信，同样也会先发送一些类似测试的指令，然而，官方文档关于这方面写的极其少，并且隐藏的很深（不好找），那么很简单，抓包看官方客户端和服务端如何通信的即可。<br>
我用的抓包工具是 WireShark，具体如何抓就不赘述了，直接贴有哪些请求的结论：</p>
<h3 id="isMaster">isMaster</h3>
<p>选择 MongoDB Compass 作为客户端（版本 &gt; 5.1），连接到 MongoDB Server。连接刚开始的时候会不断地尝试发送 <code>OP_QUERY</code> 请求。请求内容为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;flags&quot;: 0,</span><br><span class="line">    &quot;fullCollectionName&quot;: &quot;admin.$cmd&quot;,</span><br><span class="line">    &quot;numberToSkip&quot;: 0,</span><br><span class="line">    &quot;numberToReturn&quot;: -1,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;ismaster&quot;: 1,</span><br><span class="line">        &quot;helloOk&quot;: True,</span><br><span class="line">        &quot;client&quot;: &#123;</span><br><span class="line">            &quot;application&quot;: &#123;</span><br><span class="line">                &quot;name&quot;: &quot;MongoDB Compass&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;driver&quot;: &#123;</span><br><span class="line">                &quot;name&quot;: &quot;nodejs&quot;,</span><br><span class="line">                &quot;version&quot;: &quot;6.12.0&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;platform&quot;: &quot;Node.js v20.18.1, LE&quot;,</span><br><span class="line">            &quot;os&quot;: &#123;</span><br><span class="line">                &quot;name&quot;: &quot;win32&quot;,</span><br><span class="line">                &quot;architecture&quot;: &quot;x64&quot;,</span><br><span class="line">                &quot;version&quot;: &quot;10.0.22631&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;Windows_NT&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;compression&quot;: [&quot;none&quot;]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;returnFieldsSelector&quot;: None</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我把请求的全部 payload 展示出来，方便查看。isMaster 请求是一个 <code>OP_QUERY</code> 类型的消息。<br>
此事在官方文档中已有记载，虽然我们使用了新版本的 <code>OP_MSG</code>，但唯一支持的旧操作码就是这个 <code>OP_QUERY</code><br>
我本人 MongoDB 的使用经验很少，很多命令一知半解，只能大致的猜测一些字段的含义。</p>
<p>当收到 <code>OP_QUERY</code> 的 “isMaster” 请求的回复后，会<strong>接着</strong>发送一个 <code>OP_MSG</code> 的版本</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;flagBits&#x27;: 65536,</span><br><span class="line">    &#x27;sections&#x27;: [&#123;</span><br><span class="line">        &#x27;hello&#x27;: 1,</span><br><span class="line">        &#x27;maxAwaitTimeMS&#x27;: 10000,</span><br><span class="line">        &#x27;topologyVersion&#x27;: &#123;</span><br><span class="line">            &#x27;processId&#x27;: ObjectId(&#x27;679f5fe50ab84b41447995a7&#x27;),</span><br><span class="line">            &#x27;counter&#x27;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x27;$db&#x27;: &#x27;admin&#x27;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>必须要指出，topologyVersion 的 counter 的字段类型为 Long，不仔细就会当做 int 来处理了 -_-||</p>
<p><code>maxAwaitTimeMS</code> 貌似是客户端最大会等待服务器的响应时间，（后续实验出来）一旦超过这个时间，该请求就会重发</p>
<p><code>topologyVersion</code> 是一个我目前完全无法理解的东西，跳过。</p>
<p>当这个请求也被回复后，客户端发送另外一个 <code>OP_MSG</code> 请求：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;flagBits&#x27;: 0,</span><br><span class="line">    &#x27;sections&#x27;: [&#123;</span><br><span class="line">        &#x27;ping&#x27;: 1,</span><br><span class="line">        &#x27;lsid&#x27;: &#123;</span><br><span class="line">            &#x27;id&#x27;: Binary(b &#x27;\xad\x98\xeb\xe2\xa1\xf5G\xef\xbd\xcc\xde\x01H\xaeA\xa9&#x27;, 4)</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x27;$db&#x27;: &#x27;admin&#x27;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟据官方文档的说明：</p>
<blockquote>
<p>ping 命令是一个空操作，用于测试服务器是否在响应命令。即使服务器处于写锁定状态，此命令也会立即返回：<br>
lsid 指定与该命令关联的会话的唯一 ID</p>
</blockquote>
<p>至此我个人认为 isMaster 请求全部完成，至于如何响应这些请求，我会在下一章介绍。<br>
明面上，完成这些步骤后  MongoDB Compass 上已经弹出服务器连接成功的提示框了，但实际上在你主动操作前，客户端还有请求发出。</p>
<h3 id="aggregate">aggregate</h3>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&#x27;flagBits&#x27;: 0,</span><br><span class="line">	&#x27;sections&#x27;: [&#123;</span><br><span class="line">		&#x27;aggregate&#x27;: 1,</span><br><span class="line">		&#x27;pipeline&#x27;: [&#123;</span><br><span class="line">			&#x27;$currentOp&#x27;: &#123;</span><br><span class="line">				&#x27;allUsers&#x27;: True,</span><br><span class="line">				&#x27;idleConnections&#x27;: False,</span><br><span class="line">				&#x27;truncateOps&#x27;: False</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;],</span><br><span class="line">		&#x27;cursor&#x27;: &#123;&#125;,</span><br><span class="line">		&#x27;lsid&#x27;: &#123;</span><br><span class="line">			&#x27;id&#x27;: Binary(b &#x27;\xcb\xf3\xe4\x99\xca|H\xe7\x9eqZ\xea&lt;k\xec\x91&#x27;, 4)</span><br><span class="line">		&#125;,</span><br><span class="line">		&#x27;$db&#x27;: &#x27;admin&#x27;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个相当复杂的命令，官网有<a target="_blank" rel="noopener" href="https://www.mongodb.com/zh-cn/docs/manual/reference/operator/aggregation/currentOp/">解释</a>，顾名思义，是查看当然执行的命令的相关信息，更多的我暂时也不知道了。</p>
<h3 id="top-buildInfo-hostInfo">top &amp; buildInfo &amp; hostInfo</h3>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&#x27;flagBits&#x27;: 0,</span><br><span class="line">	&#x27;sections&#x27;: [&#123;</span><br><span class="line">		&#x27;top&#x27;: 1,</span><br><span class="line">		&#x27;lsid&#x27;: &#123;</span><br><span class="line">			&#x27;id&#x27;: Binary(b &#x27;l\xf3\xceRD\x08I\xf9\x8bV\x14\x91\x88aDL&#x27;, 4)</span><br><span class="line">		&#125;,</span><br><span class="line">		&#x27;$db&#x27;: &#x27;admin&#x27;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其余的命令和，比如 buildInfo 和 top 类似，只不过 sections 中的 <code>'top': 1</code> 变成了 <code>'buildInfo': 1</code></p>
<p>像这样的命令有还有 dbStats 和 atlasVersion，推测是获取一些服务器配置信息的命令。</p>
<h3 id="getParameter">getParameter</h3>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&#x27;flagBits&#x27;: 0,</span><br><span class="line">	&#x27;sections&#x27;: [&#123;</span><br><span class="line">		&#x27;getParameter&#x27;: 1,</span><br><span class="line">        &#x27;featureCompatibilityVersion&#x27;: 1</span><br><span class="line">		&#x27;lsid&#x27;: &#123;</span><br><span class="line">			&#x27;id&#x27;: Binary(b &#x27;l\xf3\xceRD\x08I\xf9\x8bV\xa1\x99\x88aDL&#x27;, 4)</span><br><span class="line">		&#125;,</span><br><span class="line">		&#x27;$db&#x27;: &#x27;admin&#x27;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="connectionStatus">connectionStatus</h3>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&#x27;flagBits&#x27;: 0,</span><br><span class="line">	&#x27;sections&#x27;: [&#123;</span><br><span class="line">		&#x27;connectionStatus&#x27;: 1,</span><br><span class="line">        &#x27;showPrivileges&#x27;: True</span><br><span class="line">		&#x27;lsid&#x27;: &#123;</span><br><span class="line">			&#x27;id&#x27;: Binary(b &#x27;B\xfd2\xc0\x8c\xf8I\xc2\x84\x08):|\x9e\x95y&#x27;, 4)</span><br><span class="line">		&#125;,</span><br><span class="line">		&#x27;$db&#x27;: &#x27;admin&#x27;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="listDatabases">listDatabases</h3>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&#x27;flagBits&#x27;: 0,</span><br><span class="line">	&#x27;sections&#x27;: [&#123;</span><br><span class="line">		&#x27;listDatabases&#x27;: 1,</span><br><span class="line">        &#x27;nameOnly&#x27;: True</span><br><span class="line">		&#x27;lsid&#x27;: &#123;</span><br><span class="line">			&#x27;id&#x27;: Binary(b&quot;V&#x27;\xe1\xcf\xe2mL&amp;\xbf`\xf0\x87\x13\xfd\xc3\xe6&quot;, 4)</span><br><span class="line">		&#125;,</span><br><span class="line">		&#x27;$db&#x27;: &#x27;admin&#x27;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最符合名字的一集，从名字就能推断出是列出现在所有的表，并且由于有 <code>nameOnly</code> 所以只需要列出名字。</p>
<h2 id="响应">响应</h2>
<p>只从文档无法推测出究竟需要返回什么样子的字段，还好我们有抓包，可以以此结果来反推信息。<br>
不过在那之前，我们要先在 Python 里完成一些基础协议数据结构的东西。</p>
<h3 id="BSON">BSON</h3>
<p>BSON（Binary JSON）是一种二进制形式的 JSON 文档。它是 MongoDB 数据库的默认数据存储格式。<br>
如何序列化这样的数据，不需要我们来完成，Python 有 支持库 <code>bson</code><br>
我们可以调用 <code>bson.encode()</code> 来将 Python 的字典变为 BSON 文档，同时使用 <code>bson.decode()</code> 将 BSON 文档转换为 Python 字典。<br>
需要注意的是，Python 的 整数默认为 Int32，当我们需要用到 Int64 类型时，可以考虑使用 <code>bson.int64.Int64()</code></p>
<h3 id="消息头-2">消息头</h3>
<p>众所周知，对于 socket 获取的流数据，一般都是二进制，并且使用 socket 发送内容的时候也要用二进制。<br>
Python 内置一个二进制数据处理的相关库 <code>struct</code>，通过使用 <code>struct.pack() | struct.unpack()</code> 可以快速将Python数据打包或者解包一个二进制数据，使用不同的“格式化字符串”可以指定打包成不同的二进制格式，比如说大小端，uint类型等等。详细的可以去查看使用文档。</p>
<p>要解包消息头，使用 <code>struct</code> 就非常的简单。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeadParser</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_decode</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="comment"># MongoDB message header</span></span><br><span class="line">        <span class="comment"># 16 bytes in total, 4 bytes each: (message length), (request id), (response to), (op code)</span></span><br><span class="line">        header = struct.unpack(<span class="string">&quot;&lt;iiii&quot;</span>, data[:<span class="number">16</span>])</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;message_length&quot;</span>: header[<span class="number">0</span>],</span><br><span class="line">            <span class="string">&quot;request_id&quot;</span>: header[<span class="number">1</span>],</span><br><span class="line">            <span class="string">&quot;response_to&quot;</span>: header[<span class="number">2</span>],</span><br><span class="line">            <span class="string">&quot;op_code&quot;</span>: header[<span class="number">3</span>]</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>而有效负载，不同的有不同的格式，<br>
我们先搓几个工具函数，它从二进制数据流中读取特定的 Python 数据。更具体的实现可以移步到该项目我的 Github 仓库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">byte2string</span>(<span class="params">data, offset</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Convert byte data to string.</span></span><br><span class="line"><span class="string">    :param data: byte data</span></span><br><span class="line"><span class="string">    :param offset: pointer to the start of the string</span></span><br><span class="line"><span class="string">    :return: pointer to the end of the string and the string</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    full_str = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="comment"># cstring end with b&#x27;\0&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> data[offset] != <span class="number">0</span>:</span><br><span class="line">        full_str += <span class="built_in">chr</span>(data[offset])</span><br><span class="line">        offset += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> offset+<span class="number">1</span>, full_str</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">byte2int32</span>(<span class="params">data, offset</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Convert byte data to integer.</span></span><br><span class="line"><span class="string">    :param data: byte data</span></span><br><span class="line"><span class="string">    :param offset: pointer to the start of the integer</span></span><br><span class="line"><span class="string">    :return: pointer to the end of the integer and the integer</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    integer = struct.unpack(<span class="string">&quot;&lt;i&quot;</span>, data[offset:offset+<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> offset+<span class="number">4</span>, integer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">byte2int64</span>(<span class="params">data, offset</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Convert byte data to integer.</span></span><br><span class="line"><span class="string">    :param data: byte data</span></span><br><span class="line"><span class="string">    :param offset: pointer to the start of the integer</span></span><br><span class="line"><span class="string">    :return: pointer to the end of the integer and the integer</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    integer = struct.unpack(<span class="string">&quot;&lt;q&quot;</span>, data[offset:offset+<span class="number">8</span>])[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> offset+<span class="number">8</span>, integer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">byte2document</span>(<span class="params">data, offset</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Covert byte data to dict object in Python</span></span><br><span class="line"><span class="string">    :param data: byte data</span></span><br><span class="line"><span class="string">    :param offset: pointer to the start of the document</span></span><br><span class="line"><span class="string">    :return: offset and decoded document result</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    doc_length = struct.unpack(<span class="string">&quot;&lt;i&quot;</span>, data[offset: offset+<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">    document = bson.decode(data[offset: offset+doc_length])</span><br><span class="line">    offset += doc_length</span><br><span class="line">    <span class="keyword">return</span> offset, document</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">byte2uint32</span>(<span class="params">data, offset</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Convert byte data to unsigned integer.</span></span><br><span class="line"><span class="string">    :param data: byte data</span></span><br><span class="line"><span class="string">    :param offset: pointer to the start of the integer</span></span><br><span class="line"><span class="string">    :return: pointer to the end of the integer and the integer</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    integer = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, data[offset:offset+<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> offset+<span class="number">4</span>, integer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">byte2sections</span>(<span class="params">data, offset</span>):</span></span><br><span class="line">    current_offset = offset</span><br><span class="line">    current_offset, section_size = byte2int32(data, current_offset)</span><br><span class="line">    section_name = byte2string(data, current_offset)</span><br><span class="line">    documents = []</span><br><span class="line">    <span class="keyword">while</span> current_offset &lt; offset + section_size:</span><br><span class="line">        current_offset, document = byte2document(data, current_offset)</span><br><span class="line">        documents.append(document)</span><br><span class="line">    res = &#123;</span><br><span class="line">        section_name: documents</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> current_offset, res</span><br></pre></td></tr></table></figure>
<h3 id="CRC-校验">CRC 校验</h3>
<p>不算太难，内置库 <code>zlib</code> 有现成的轮子调用，直接给出实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crc32_checksum</span>(<span class="params">raw_data, checksum</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Calculate the CRC32 checksum of the given data and compare it with the given checksum.</span></span><br><span class="line"><span class="string">    :param raw_data: Total data except the checksum</span></span><br><span class="line"><span class="string">    :param checksum: The expected checksum</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    computed_checksum = zlib.crc32(raw_data) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> computed_checksum == checksum</span><br></pre></td></tr></table></figure>
<p>有了这些基本的认知还有工具，下一节我们来实现一个应答这些请求的服务器。<s>里面也有很多坑</s></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>单文件 MongoDB 服务器（1）</p><p><a href="http://cyx0706.github.io/2025/03/20/mongodb/">http://cyx0706.github.io/2025/03/20/mongodb/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Ctwo</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2025-03-20</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-05-08</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/mongodb/">mongodb</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/05/31/hello-scientific-research/"><span class="level-item">走出疫情，走出个人阴影</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "3961b0383b1acbfcc73421cf593ad8b5",
            repo: "yuictwo.github.io",
            owner: "yuictwo",
            clientID: "4d458c0d13a2c2157dbd",
            clientSecret: "99a8159ca4a12d236f888be149168b92808a4e29",
            admin: ["yuictwo"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#引子"><span class="level-left"><span class="level-item">1</span><span class="level-item">引子</span></span></a></li><li><a class="level is-mobile" href="#消息头"><span class="level-left"><span class="level-item">2</span><span class="level-item">消息头</span></span></a></li><li><a class="level is-mobile" href="#有效负载"><span class="level-left"><span class="level-item">3</span><span class="level-item">有效负载</span></span></a></li><li><a class="level is-mobile" href="#握手请求"><span class="level-left"><span class="level-item">4</span><span class="level-item">握手请求</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#isMaster"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">isMaster</span></span></a></li><li><a class="level is-mobile" href="#aggregate"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">aggregate</span></span></a></li><li><a class="level is-mobile" href="#top-buildInfo-hostInfo"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">top &amp; buildInfo &amp; hostInfo</span></span></a></li><li><a class="level is-mobile" href="#getParameter"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">getParameter</span></span></a></li><li><a class="level is-mobile" href="#connectionStatus"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">connectionStatus</span></span></a></li><li><a class="level is-mobile" href="#listDatabases"><span class="level-left"><span class="level-item">4.6</span><span class="level-item">listDatabases</span></span></a></li></ul></li><li><a class="level is-mobile" href="#响应"><span class="level-left"><span class="level-item">5</span><span class="level-item">响应</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#BSON"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">BSON</span></span></a></li><li><a class="level is-mobile" href="#消息头-2"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">消息头</span></span></a></li><li><a class="level is-mobile" href="#CRC-校验"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">CRC 校验</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Ctwo&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2025 Ctwo</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/YuiCtwo"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mhchem.min.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>